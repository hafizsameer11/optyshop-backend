name: Deploy Backend with Migrations

on:
  push:
    branches: [main, master, production]
  workflow_dispatch:

permissions:
  contents: read
  packages: write

concurrency:
  group: production-deploy
  cancel-in-progress: true

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    timeout-minutes: 30

    # ‚úÖ Map secrets ‚Üí env (REQUIRED for if conditions)
    env:
      NODE_VERSION: '18'
      APP_DIR: /app

      DOCKER_REGISTRY: ${{ secrets.DOCKER_REGISTRY }}
      DOCKER_IMAGE_NAME: ${{ secrets.DOCKER_IMAGE_NAME }}
      DOCKER_CONTAINER_NAME: ${{ secrets.DOCKER_CONTAINER_NAME }}

      DEPLOY_SSH_HOST: ${{ secrets.DEPLOY_SSH_HOST }}
      DEPLOY_SSH_USER: ${{ secrets.DEPLOY_SSH_USER }}
      DEPLOY_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
      DEPLOY_SSH_PORT: ${{ secrets.DEPLOY_SSH_PORT }}

      HEALTH_CHECK_URL: ${{ secrets.HEALTH_CHECK_URL }}
      DATABASE_URL: ${{ secrets.DATABASE_URL }}

    steps:
      # -----------------------------
      # Checkout
      # -----------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------
      # Node Setup
      # -----------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      # -----------------------------
      # Install
      # -----------------------------
      - name: Install dependencies
        run: npm install

      # -----------------------------
      # ENV Validation
      # -----------------------------
      - name: Validate environment variables
        run: |
          if [ -z "$DATABASE_URL" ]; then
            echo "‚ùå DATABASE_URL missing"
            exit 1
          fi
          echo "‚úÖ Environment validated"

      # -----------------------------
      # Prisma
      # -----------------------------
      - name: Generate Prisma Client
        run: npx prisma generate

      - name: Verify database connection
        run: npx prisma validate || echo "‚ö†Ô∏è Validation skipped"

      # -----------------------------
      # Migrations
      # -----------------------------
      - name: Run database migrations
        run: |
          echo "üö® Applying banner fix"

          npx prisma db execute --stdin << 'EOF'
          ALTER TABLE banners
            ADD COLUMN IF NOT EXISTS page_type ENUM('home','category','subcategory','sub_subcategory')
            NOT NULL DEFAULT 'home';

          ALTER TABLE banners
            ADD COLUMN IF NOT EXISTS category_id INT NULL;

          ALTER TABLE banners
            ADD COLUMN IF NOT EXISTS sub_category_id INT NULL;
          EOF || echo "‚úÖ Columns already exist"

          echo "üîÑ Regenerating Prisma Client"
          npx prisma generate --force

          echo "üì¶ Running migrations"
          npx prisma migrate deploy

      - name: Verify migration status
        run: npx prisma migrate status

      # =====================================================
      # DOCKER DEPLOYMENT
      # =====================================================
      - name: Build & Push Docker Image
        if: env.DOCKER_REGISTRY != ''
        run: |
          echo "${{ secrets.DOCKER_REGISTRY_PASSWORD }}" | docker login $DOCKER_REGISTRY \
            -u "${{ secrets.DOCKER_REGISTRY_USERNAME }}" --password-stdin

          docker build -t $DOCKER_IMAGE_NAME:latest .
          docker push $DOCKER_IMAGE_NAME:latest

      - name: Deploy Docker container via SSH
        if: env.DOCKER_REGISTRY != '' && env.DEPLOY_SSH_HOST != ''
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ env.DEPLOY_SSH_HOST }}
          username: ${{ env.DEPLOY_SSH_USER }}
          key: ${{ env.DEPLOY_SSH_KEY }}
          port: ${{ env.DEPLOY_SSH_PORT }}
          script: |
            set -e
            cd ${{ env.APP_DIR }}

            docker pull $DOCKER_IMAGE_NAME:latest
            docker stop $DOCKER_CONTAINER_NAME || true
            docker rm $DOCKER_CONTAINER_NAME || true

            docker run -d \
              --name $DOCKER_CONTAINER_NAME \
              -p 3000:3000 \
              --env-file .env \
              $DOCKER_IMAGE_NAME:latest

      # =====================================================
      # DIRECT SSH DEPLOYMENT (NO DOCKER)
      # =====================================================
      - name: Deploy via SSH (Direct)
        if: env.DOCKER_REGISTRY == '' && env.DEPLOY_SSH_HOST != ''
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ env.DEPLOY_SSH_HOST }}
          username: ${{ env.DEPLOY_SSH_USER }}
          key: ${{ env.DEPLOY_SSH_KEY }}
          port: ${{ env.DEPLOY_SSH_PORT }}
          script: |
            set -e
            cd ${{ env.APP_DIR }}

            echo "üì¶ Backup"
            cp -r . ../backup-$(date +%Y%m%d-%H%M%S) || true

            git pull origin main || git pull origin master
            npm install --production
            npx prisma generate

            pm2 restart all || sudo systemctl restart backend || true

      # -----------------------------
      # HEALTH CHECK
      # -----------------------------
      - name: Health check
        if: env.HEALTH_CHECK_URL != ''
        run: |
          echo "ü©∫ Checking health..."
          for i in {1..5}; do
            if curl -fsS $HEALTH_CHECK_URL/health; then
              echo "‚úÖ Health check passed"
              exit 0
            fi
            echo "‚è≥ Retry $i"
            sleep 5
          done
          echo "‚ùå Health check failed"
          exit 1

      # -----------------------------
      # FINAL STATUS
      # -----------------------------
      - name: Deployment notification
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "‚úÖ Deployment completed successfully"
          else
            echo "‚ùå Deployment failed"
          fi
